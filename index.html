<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OCEAN TIDES Live Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #050505; color: #00ffcc; text-align: center; padding: 40px; }
        .card { background: #111; border: 1px solid #333; padding: 30px; border-radius: 12px; display: inline-block; min-width: 350px; }
        .value { font-size: 3.5rem; font-weight: bold; color: #fff; margin: 10px 0; }
        .label { color: #888; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        
        /* Calibration Bar */
        .progress-container { background: #222; border-radius: 10px; height: 20px; width: 100%; margin: 20px 0; overflow: hidden; border: 1px solid #444; }
        .progress-bar { background: linear-gradient(90deg, #0066ff, #00ffcc); height: 100%; width: 0%; transition: width 0.5s ease; }
        .status-text { font-size: 0.85rem; color: #666; }
    </style>
</head>
<body>
    <div class="card">
        <div class="label">TIDES Window (8-Block Target)</div>
        <div id="window-val" class="value">Loading...</div>
        
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        
        <div id="status" class="status-text">Analyzing CSV history...</div>
        <div id="details" style="color: #444; font-size: 0.75rem; margin-top: 15px;"></div>
    </div>

    <script>
        async function calculate() {
            Papa.parse("data/history.csv", {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    const rows = results.data.filter(r => r.hashrate > 0);
                    if (rows.length === 0) {
                        document.getElementById('status').innerText = "No data found in data/history.csv";
                        return;
                    }

                    const latest = rows[rows.length - 1];
                    const targetWork = latest.window_target; // Total shares for 8 blocks
                    
                    let accumulatedWork = 0;
                    let secondsBack = 0;
                    let isCalibrated = false;

                    // Walk back to see how long it takes to reach targetWork
                    for (let i = rows.length - 1; i >= 0; i--) {
                        // Convert Hashes/s to Diff-1 Shares over 10 mins (600s)
                        let intervalWork = (rows[i].hashrate / Math.pow(2, 32)) * 600;
                        accumulatedWork += intervalWork;
                        secondsBack += 600;
                        
                        if (accumulatedWork >= targetWork) {
                            isCalibrated = true;
                            break;
                        }
                    }

                    // Update UI
                    const windowDisplay = document.getElementById('window-val');
                    const progressBar = document.getElementById('progress-bar');
                    const statusText = document.getElementById('status');
                    
                    const coveragePercent = Math.min((accumulatedWork / targetWork) * 100, 100).toFixed(1);
                    progressBar.style.width = coveragePercent + "%";

                    if (isCalibrated) {
                        windowDisplay.innerText = (secondsBack / 3600).toFixed(2) + " hrs";
                        windowDisplay.style.color = "#fff";
                        statusText.innerText = "Window Locked (100% Coverage)";
                    } else {
                        windowDisplay.innerText = (secondsBack / 3600).toFixed(2) + " hrs*";
                        windowDisplay.style.color = "#f39c12";
                        statusText.innerText = `Calibrating: ${coveragePercent}% of window data collected`;
                    }

                    document.getElementById('details').innerText = 
                        `Current Pool: ${(latest.hashrate / 1e18).toFixed(2)} Eh/s | Data Points: ${rows.length}`;
                }
            });
        }
        // Refresh every minute to check for new data from the Action
        calculate();
        setInterval(calculate, 60000);
    </script>
</body>
</html>
